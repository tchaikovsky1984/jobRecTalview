import json
import pandas as pd
import os
from pandas.io.sql import execute
import psycopg2
import numpy as np
from psycopg2.extras import execute_values
from typing import Dict
from temporalio import activity
from dotenv import load_dotenv

from src.shared import DBInsertData

@activity.defn
def storer(insert_info: DBInsertData) -> bool:
    try:
        df = pd.read_csv(insert_info.file_path)

        if 'embedding' in df.columns:
            df['embedding'] = df['embedding'].apply(
                lambda x: json.loads(x) if isinstance(x, str) else x
            )
        df = df.replace({np.nan: None})

        db_info = loading_vars()
        conn = psycopg2.connect(database=db_info["pg_name"], user=db_info["pg_user"], host=db_info["pg_url"], port=db_info["pg_port"], password=db_info["pg_pass"])
        cursor = conn.cursor() 

        records = df.to_dict("records")

        l = []
        for row in records:
            l.append((row["title"], row["company"], row["description"] if row["description"] is not None else "", row["location"], row["embedding"], row["url"], insert_info.search_title, insert_info.search_pref_country, insert_info.search_pref_area))

        execute_values(
                cursor,
                "INSERT INTO job (title, company, description, location, embedding, url, search_title, search_pref_country, search_pref_area) VALUES %s",
                l
                )

        print(f"inserted {len(records)} rows")

        conn.commit()
        cursor.close()
        conn.close()

        return True
    except Exception as e:
        print(e)
        raise e

def loading_vars() -> Dict[str, str]:
    try:
        load_dotenv()
        pg_name = os.getenv("PG_NAME", "chat_app_db")
        pg_url = os.getenv("PG_URL", "localhost")
        pg_port = os.getenv("PG_PORT", "5500")
        pg_user = os.getenv("PG_USER", "chat_user")
        pg_pass = os.getenv("PG_SECRET", "changethispassword")

        db_info = {
            "pg_name": pg_name,
            "pg_url": pg_url,
            "pg_port": pg_port,
            "pg_user": pg_user,
            "pg_pass": pg_pass,
        }

        return db_info
    except Exception as e:
        print(e)
        raise e
